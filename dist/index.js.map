{"version":3,"sources":["index.js"],"names":["createExec","gun","opts","logging","log","isObj","obj","commands","arrWrapObj","Error","flatten","a","Array","isArray","concat","map","normalizeArgs","args","normalizeArr","defaultLog","level","validateCommand","commandName","defaultIsValidRoot","command","node","isValidRoot","execute","gunInstance","options","reduce","root","name","model","keys","ctx","returnVal","apply","e"],"mappings":"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","file":"index.js","sourcesContent":["export default function createExec(gun, opts = {}) {\n  let {\n    logging,\n    log,\n  } = opts\n\n  function isObj(obj) {\n    return (typeof commands !== 'object')\n  }\n\n  function arrWrapObj(obj) {\n    if (!isObj(obj)) {\n      throw new Error(`Each command must be an object, was: ${typeof obj} ${obj}`)\n    }\n    return [obj]\n  }\n\n  function flatten(a) {\n    return Array.isArray(a) ? [].concat(...a.map(flatten)) : a;\n  }\n\n  function normalizeArgs(args) {\n    args = flatten(args)\n    return normalizeArr(args)\n  }\n\n  function normalizeArr(obj) {\n    return Array.isArray(obj) ? obj : arrWrapObj(obj)\n  }\n\n  function defaultLog(level, ...args) {\n    if (logging) {\n      console.log(...args)\n    }\n  }\n\n  log = log || defaultLog\n\n  function validateCommand(commandName, args) {\n    if (!Array.isArray(args)) {\n      throw new Error(`Invalid arguments ${args}`)\n    }\n    if (typeof commandName !== 'string') {\n      throw new Error(`Invalid command ${commandName}`)\n    }\n  }\n\n  function defaultIsValidRoot(command, node) {\n    if (command === 'put' || command === 'set') {\n      return false\n    }\n    return true\n  }\n  let isValidRoot = opts.isValidRoot || defaultIsValidRoot\n\n  return function execute(gunInstance, commands, options) {\n    logging = options ? options.logging : logging\n\n    // must be Object or Array\n    if (!isObj(commands)) {\n      log('error', 'execute: Invalid commands ', commands)\n      throw new Error('Execute command argument must be an Object or Array')\n    }\n    commands = normalizeArr(commands)\n\n    return commands.reduce((node, command) => {\n      // rewind to root level of gunInstance\n      if (command.root && isValidRoot(command, node)) {\n        log('info', 'chain reset to root')\n        node = gunInstance\n        delete command.root\n      }\n      log('info', 'command', command)\n\n      let name\n      let args = []\n      if (command.name) {\n        // {name: 'put', args: [{ name: 'kris' }, { sync: false }] }\n        name = command.name\n        args = command.args\n\n        if (command.model) {\n          args = command.model || args\n        }\n      } else {\n        // extract from key/value pair\n        // { put: [{ name: 'kris' }, { sync: false }] }\n        let keys = Object.keys(command)\n        name = keys[0]\n        args = command[name]\n      }\n\n      let commandName = name\n\n      let ctx = node\n      let returnVal\n      args = normalizeArgs(args)\n\n      function validateCommand(commandName, args) {\n        if (!Array.isArray(args)) {\n          throw new Error(`Invalid arguments ${args}`)\n        }\n        if (typeof commandName !== 'string') {\n          throw new Error(`Invalid command ${commandName}`)\n        }\n      }\n\n      validateCommand(commandName, args)\n\n      log('info', 'execute', commandName, args)\n      try {\n        returnVal = node[commandName].apply(ctx, args)\n      } catch (e) {\n        log('error', node)\n        throw new Error(`execute: Failed applying ${command}`)\n      }\n      return returnVal\n    }, gunInstance)\n  }\n}"]}